<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manutenção de Equipamentos</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let jsonData = [];
        let mttoChart, mttpmChart, mttqeChart, availabilityChart, equipamentosGerais, chartTaxaDisponibilidadePercentual, chartMOFM;

        async function loadData() {
            const apiKey = 'AIzaSyBSSxNV1h0oggNmh7FOlSUExFJHJGb4hOY';
            const spreadsheetId = '19h5tX7GVEhgpcZRxnQhc4_2gDt5ucZS4SRO-PT7g88Q';
            const range = 'Base De Dados!A1:Z1000000';

            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`);
            const data = await response.json();

            const headers = data.values[0];
            jsonData = data.values.slice(1).map(row => {
                let obj = {};
                row.forEach((cell, index) => {
                    obj[headers[index]] = cell;
                });
                return obj;
            });

            console.log(jsonData);
            renderDashboard(jsonData);
        }

        function renderDashboard(data) {
            renderEquipmentSelection(data);

            renderMetrics(data);
        }

        function sortEquipmentTypes(types) {
            types.sort((a, b) => {
                // Extrai o número após o "P" para comparação numérica
                const numA = parseInt(a.substring(1));
                const numB = parseInt(b.substring(1));

                // Compara os números após o "P"
                if (numA < numB) return -1;
                if (numA > numB) return 1;
                return 0;
            });

            return types;
        }

        function renderEquipmentSelection(data) {
            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);
            console.log('equipments', equipmentTypes);

            const selectEquipment = document.getElementById('selectEquipment');

            const allOption = document.createElement('option');
            allOption.textContent = 'Total';
            allOption.value = '0';
            selectEquipment.appendChild(allOption);

            equipmentTypes.forEach(equipment => {
                const option = document.createElement('option');
                option.textContent = equipment;
                option.value = equipment;
                selectEquipment.appendChild(option);
            });

            selectEquipment.addEventListener('change', () => {
                const selectedEquipment = selectEquipment.value;
                const filteredData = selectedEquipment == 0 ? data : data.filter(item => item.Equipamento === selectedEquipment);
                console.log('filterred', filteredData, selectedEquipment)
                destroyCharts();
                renderMetrics(filteredData);
            });
        }

        function renderMetrics(data) {
            renderTotalEquipment(data);
            renderNumberBreakdowns(data);
            renderNumberPreventiveMaintenances(data);
            renderChartMTTO(data);
            renderChartMTTMP(data);
            renderChartMTTQE(data);
            renderChartAvailability(data);
            renderChartTaxaDisponibilidade(data);
            renderChartMOFM(data)

        }

        function destroyCharts() {
            if (mttoChart) {
                mttoChart.destroy();
            }
            if (mttpmChart) {
                mttpmChart.destroy();
            }
            if (mttqeChart) {
                mttqeChart.destroy();
            }
            if (availabilityChart) {
                availabilityChart.destroy();
            }
            if (chartTaxaDisponibilidadePercentual) {
                chartTaxaDisponibilidadePercentual.destroy();
            }
            if (chartMOFM) {
                chartMOFM.destroy();
            }
        }

        function converterDataBrasileiraParaDate(dataBrasileira) {
            const partes = dataBrasileira.split(/[ /:]/); // Dividir por /, espaço e :

            const data = new Date(partes[2], partes[1] - 1, partes[0], partes[3], partes[4], partes[5]);

            return data;
        }

        function calcularMediaMTTO(eventos) {
            const eventosFiltrados = eventos.filter(evento => evento.CodEvento === '264');
            const mttoPorEquipamento = {};

            eventosFiltrados.forEach(evento => {
                const inicio = converterDataBrasileiraParaDate(evento.InicioEvento);
                const fim = converterDataBrasileiraParaDate(evento.FimEvento);

                if (!isNaN(inicio) && !isNaN(fim)) {
                    const diffMinutos = (fim - inicio) / (1000 * 60 * 60); // Diferença em minutos
                    if (!mttoPorEquipamento[evento.Equipamento]) {
                        mttoPorEquipamento[evento.Equipamento] = [];
                    }
                    mttoPorEquipamento[evento.Equipamento].push(diffMinutos);
                } else {
                    console.error(`Data inválida para evento: ${JSON.stringify(evento)}`);
                }
            });

            const mediaMTTO = {};
            for (const equipamento in mttoPorEquipamento) {
                const tempos = mttoPorEquipamento[equipamento];
                const media = tempos.reduce((total, tempo) => total + tempo, 0) / tempos.length;
                mediaMTTO[equipamento] = media;
            }

            return mediaMTTO;
        }

        function renderChartMTTO(data) {
            const ctxMTTO = document.getElementById('chartMTTO').getContext('2d');
            const equipmentLabels = data.map(item => item.Equipamento);
            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);
            console.log('rquips', equipmentTypes)
            const eventosFiltrados = data.filter(evento => evento.CodEvento === '264');

            const mttoPorEquipamento = eventosFiltrados.reduce((resultado, evento) => {
                const tempoInicio = converterDataBrasileiraParaDate(evento.InicioEvento);
                const tempoFim = converterDataBrasileiraParaDate(evento.FimEvento);
                const diffMinutos = (tempoFim - tempoInicio) / (1000 * 60 * 60); 

                resultado[evento.Equipamento] = (resultado[evento.Equipamento] || []);
                resultado[evento.Equipamento].push(diffMinutos);
                return resultado;
            }, {});

            const mediaMTTO = {};
            for (const equipamento in mttoPorEquipamento) {
                const tempos = mttoPorEquipamento[equipamento];
                const media = tempos.reduce((total, tempo) => total + tempo, 0) / tempos.length;
                mediaMTTO[equipamento] = media;
            }

            console.log('Média do tempo de manutenção (MTTO) por equipamento:');
            console.log(mediaMTTO);

            mttoChart = new Chart(ctxMTTO, {
                type: 'bar',
                data: {
                    labels: equipmentTypes,
                    datasets: [{
                        label: 'Tempo Médio de Operação (MTTO)',
                        data: mediaMTTO,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                }
            });
        }

        function renderChartMTTMP(data) {
            const ctxMTTMP = document.getElementById('chartMTTMP').getContext('2d');
            const equipmentLabels = data.map(item => item.Equipamento);
            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);

            const eventosFiltrados = data.filter(evento => evento.CodEvento === '241');

            const mttoPorEquipamento = eventosFiltrados.reduce((resultado, evento) => {
                const tempoInicio = converterDataBrasileiraParaDate(evento.InicioEvento);
                const tempoFim = converterDataBrasileiraParaDate(evento.FimEvento);
                const diffMinutos = (tempoFim - tempoInicio) / (1000 * 60 * 60); // Diferença em minutos

                resultado[evento.Equipamento] = (resultado[evento.Equipamento] || []);
                resultado[evento.Equipamento].push(diffMinutos);
                return resultado;
            }, {});

            const MTTMP = {};
            for (const equipamento in mttoPorEquipamento) {
                const tempos = mttoPorEquipamento[equipamento];
                const media = tempos.reduce((total, tempo) => total + tempo, 0) / tempos.length;
                MTTMP[equipamento] = media;
            }

            console.log('Tempo Médio de Manutenção Preventiva (MTTMP)');
            console.log(MTTMP);


            mttpmChart = new Chart(ctxMTTMP, {
                type: 'bar',
                data: {
                    labels: equipmentTypes,
                    datasets: [{
                        label: 'Tempo Médio de Manutenção Preventiva (MTTMP)',
                        data: MTTMP,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                }
            });
        }


        function calcularMTTQE(dados) {
            const totalPorEquipamento = {};
            const countPorEquipamento = {};

            dados.forEach(evento => {
                    if(evento.FimEvento != null){
                        const equipamento = evento.Equipamento;
                        const inicioEvento = converterDataBrasileiraParaDate(evento.InicioEvento);
                        const fimEvento = converterDataBrasileiraParaDate(evento.FimEvento);
                        const diffMinutes  = (fimEvento - inicioEvento) / (1000 * 60 * 60);
                        console.log(diffMinutes)
                        if (!totalPorEquipamento[equipamento]) {
                            totalPorEquipamento[equipamento] = 0;
                            countPorEquipamento[equipamento] = 0;
                        }
                        totalPorEquipamento[equipamento] += diffMinutes;
                        countPorEquipamento[equipamento]++;
                } 
               
            });

            const mttqePorEquipamento = {};

            // Calcular a média para cada equipamento
            Object.keys(totalPorEquipamento).forEach(equipamento => {
                const total = totalPorEquipamento[equipamento];
                const count = countPorEquipamento[equipamento];
                const mttqe = total / count;
                mttqePorEquipamento[equipamento] = mttqe;
            });

            return mttqePorEquipamento;
        }


        function renderChartMTTQE(data) {
            const ctxMTTQE = document.getElementById('chartMTTQE').getContext('2d');
            const equipmentLabels = data.map(item => item.Equipamento);
            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);

            const eventosFiltrados = data.filter(evento => evento.CodEvento === '414');

            const resultadoMTTQE = calcularMTTQE(eventosFiltrados);
            console.log('resttt', resultadoMTTQE);

            mttqeChart = new Chart(ctxMTTQE, {
                type: 'bar',
                data: {
                    labels: equipmentTypes,
                    datasets: [{
                        label: 'Tempo Médio de Quebra de Equipamento (MTTQE)',
                        data: resultadoMTTQE,
                        backgroundColor: 'rgba(255, 206, 86, 0.5)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                }
            });
        }

        function renderChartMOFM(data) {
            const ctxMOFM = document.getElementById('chartMOFM').getContext('2d');
            const equipmentLabels = data.map(item => item.Equipamento);
            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);

            const eventosFiltrados = data.filter(evento => evento.CodEvento === '241');

            const mttoPorEquipamento = eventosFiltrados.reduce((resultado, evento) => {
                const tempoInicio = converterDataBrasileiraParaDate(evento.InicioEvento);
                const tempoFim = converterDataBrasileiraParaDate(evento.FimEvento);
                const diffMinutos = (tempoFim - tempoInicio) / (1000 * 60 * 60); 

                resultado[evento.Equipamento] = (resultado[evento.Equipamento] || []);
                resultado[evento.Equipamento].push(diffMinutos);
                return resultado;
            }, {});

            console.log('mto', mttoPorEquipamento)

            const mttqeData = {};
            for (const equipamento in mttoPorEquipamento) {
                const tempos = mttoPorEquipamento[equipamento];
                const media = tempos.reduce((total, tempo) => total + tempo, 0) / tempos.length;
                mttqeData[equipamento] = media;
            }

            /////////////////////////////////////

            const eventosFiltrados2 = data.filter(evento => evento.CodEvento === '414');

            const resultadoMTTQE = calcularMTTQE(eventosFiltrados2);
            console.log('resttt', resultadoMTTQE);


            console.log('Tempo Médio de Quebra de Equipamento (MTTQE)');
            console.log(mttqeData);

            chartMOFM = new Chart(ctxMOFM, {
                type: 'bar',
                data: {
                    labels: equipmentTypes,
                    datasets: [{
                        label: 'Tempo Médio de Manutenção Preventiva (MTTMP)',
                        data: mttqeData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Tempo Médio de Quebra de Equipamento (MTTQE)',
                        data: resultadoMTTQE,
                        backgroundColor: 'rgba(255, 206, 86, 0.5)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                }
            });
        }



        function calcularTaxaDeFalha(data) {
            const equipamentos = {};
            const resultados = [];

            data.forEach(item => {
                const equipamento = item.Equipamento;
                const codEvento = parseInt(item.CodEvento);
                const inicioEvento = converterDataBrasileiraParaDate(item.InicioEvento);
                const fimEvento = item.FimEvento != null ? converterDataBrasileiraParaDate(item.FimEvento) : null;

                if (!equipamentos[equipamento]) {
                    equipamentos[equipamento] = {
                        totalFalhas: 0,
                        periodoDias: 0
                    };
                }

                if (codEvento === 414) {
                    equipamentos[equipamento].totalFalhas++;

                    if (equipamentos[equipamento].periodoDias === 0) {
                        equipamentos[equipamento].inicioPeriodo = inicioEvento;
                        equipamentos[equipamento].fimPeriodo = fimEvento;
                    } else {
                        if (fimEvento > equipamentos[equipamento].fimPeriodo) {
                            equipamentos[equipamento].fimPeriodo = fimEvento;
                        }
                    }

                    if (equipamentos[equipamento].inicioPeriodo && equipamentos[equipamento].fimPeriodo) {
                        const diffTime = Math.abs(equipamentos[equipamento].fimPeriodo - equipamentos[equipamento].inicioPeriodo);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        equipamentos[equipamento].periodoDias = diffDays;
                    }
                }
            });

            Object.keys(equipamentos).forEach(equipamento => {
                const { totalFalhas, periodoDias } = equipamentos[equipamento];

                const taxaFalhaPorDia = totalFalhas / periodoDias;

                const taxaFalhaPorDiaArredondada = Math.round(taxaFalhaPorDia * 100) / 100;

                resultados.push({
                    Equipamento: equipamento,
                    TotalFalhas: totalFalhas,
                    PeriodoDias: periodoDias,
                    TaxaFalhaPorDia: taxaFalhaPorDiaArredondada
                });
            });

            resultados.sort((a, b) => {
                const equipA = parseInt(a.Equipamento.replace("P", ""));
                const equipB = parseInt(b.Equipamento.replace("P", ""));
                return equipA - equipB;
            });

            console.log('rest', resultados)
            return resultados;
        }


        function renderChartAvailability(data) {
            const eventosFiltrados = data.filter(evento => evento.CodEvento === '264');
            const disponibilidadeEquipamentos = calcularTaxaDeFalha(data);
            console.log('disp', disponibilidadeEquipamentos)
            const ctxAvailability = document.getElementById('chartAvailability').getContext('2d');
            const equipmentLabels = disponibilidadeEquipamentos.map(item => item.Equipamento);
            const availabilityData = disponibilidadeEquipamentos.map(item => parseFloat(item.TaxaFalhaPorDia));
            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);


            availabilityChart = new Chart(ctxAvailability, {
                type: 'bar',
                data: {
                    labels: equipmentTypes,
                    datasets: [{
                        label: 'Taxa de Falhas por Dia (%)',
                        data: availabilityData,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                }

            });
        }

        function renderChartTaxaDisponibilidade(data) {
            const disponibilidadeEquipamentos = calcularTaxaDisponibilidade(data);

            console.log('xx', disponibilidadeEquipamentos);

            const TaxaDisponibilidadePercentual = document.getElementById('chartTaxaDisponibilidadePercentual').getContext('2d');
            const equipmentLabels = disponibilidadeEquipamentos.map(item => item.Equipamento);
            const availabilityData = disponibilidadeEquipamentos.map(item => parseFloat(item.TaxaDisponibilidadePercentual));
            const totalDaysData = disponibilidadeEquipamentos.map(item => item.DiasMonitoramento);

            var equipmentTypes = [...new Set(data.map(item => item.Equipamento))];
            equipmentTypes = sortEquipmentTypes(equipmentTypes);

            chartTaxaDisponibilidadePercentual = new Chart(TaxaDisponibilidadePercentual, {
                type: 'bar',
                data: {
                    labels: equipmentTypes,
                    datasets: [{
                        label: 'Taxa de Disponibilidade (%) ',
                        data: availabilityData,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, data) {
                                console.log('')
                                const equipamento = data.labels[tooltipItem.index];
                                const taxaDisponibilidade = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                                const diasMonitoramento = totalDaysData[tooltipItem.index];
                                return `${equipamento}: ${taxaDisponibilidade.toFixed(2)}% (Dias: ${diasMonitoramento.toFixed(2)})`;
                            }
                        }
                    }
                }
            });
        }

        function calcularTaxaDisponibilidade(data) {
            const equipamentos = {};
            const resultados = [];

            data.forEach(item => {
                const equipamento = item.Equipamento;
                const codEvento = parseInt(item.CodEvento);
                const inicioEvento = converterDataBrasileiraParaDate(item.InicioEvento);
                const fimEvento = item.FimEvento ? converterDataBrasileiraParaDate(item.FimEvento) : null;

                if (!equipamentos[equipamento]) {
                    equipamentos[equipamento] = {
                        totalMinutosOperacao: 0,
                        inicioMonitoramento: inicioEvento,
                        fimMonitoramento: fimEvento || inicioEvento,
                    };
                }

                if (codEvento === 264 && fimEvento) {
                    const minutosEvento = (fimEvento - inicioEvento) / (1000 * 60); // Duração em minutos
                    equipamentos[equipamento].totalMinutosOperacao += minutosEvento;
                }

                if (inicioEvento < equipamentos[equipamento].inicioMonitoramento) {
                    equipamentos[equipamento].inicioMonitoramento = inicioEvento;
                }
                if (fimEvento && fimEvento > equipamentos[equipamento].fimMonitoramento) {
                    equipamentos[equipamento].fimMonitoramento = fimEvento;
                }
            });

            Object.keys(equipamentos).forEach(equipamento => {
                const totalMinutosOperacao = equipamentos[equipamento].totalMinutosOperacao;
                const totalMinutosMonitoramento = (equipamentos[equipamento].fimMonitoramento - equipamentos[equipamento].inicioMonitoramento) / (1000 * 60); // Duração em minutos
                const taxaDisponibilidade = (totalMinutosOperacao * 100.0) / totalMinutosMonitoramento;
                const diasMonitoramento = totalMinutosMonitoramento / (60 * 24);

                resultados.push({
                    Equipamento: equipamento,
                    TaxaDisponibilidadePercentual: taxaDisponibilidade,
                    DiasMonitoramento: diasMonitoramento,
                });
            });

            resultados.sort((a, b) => {
                const equipA = parseInt(a.Equipamento.replace("P", ""));
                const equipB = parseInt(b.Equipamento.replace("P", ""));
                return equipA - equipB;
            });

            console.log('resultadosdispon', resultados);
            return resultados;
        }
        
        function renderNumberBreakdowns(data) {
            const numberBreakdowns = document.getElementById('numberBreakdowns');
            var filtrada = data.filter((i) => i.CodEvento == '414');
            const totalBreakdowns = filtrada.length
            console.log('totvr', totalBreakdowns)
            numberBreakdowns.textContent = totalBreakdowns;
        }

        function renderNumberPreventiveMaintenances(data) {
            const numberPreventiveMaintenances = document.getElementById('numberPreventiveMaintenances');
            var filtrada = data.filter((i) => i.CodEvento == '241');
            const totalPreventiveMaintenances = filtrada.length
            numberPreventiveMaintenances.textContent = totalPreventiveMaintenances;
        }

        function renderTotalEquipment(data) {
            const totalEquipment = document.getElementById('totalEquipment');
            const uniqueEquipment = [...new Set(data.map(item => item.Equipamento))];
            totalEquipment.textContent = uniqueEquipment.length;
        }
    </script>
</head>

<body onload="loadData()">
    <div class="container mt-5">
        <h1 class="mb-4">Painel de Indicadores</h1>
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label for="selectEquipment">Selecione o Equipamento:</label>
                    <select id="selectEquipment" class="form-control">
                    </select>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total de Equipamentos</h5>
                        <p class="card-text" id="totalEquipment">-</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Número Total de Quebras</h5>
                        <p class="card-text" id="numberBreakdowns">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Número Total de Manutenções Preventivas</h5>
                        <p class="card-text" id="numberPreventiveMaintenances">-</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tempo Total Operação/Falhas/M. Preventiva</h5>
                        <canvas id="chartMOFM" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tempo Médio de Operação (MTTO)</h5>
                        <canvas id="chartMTTO" height="150"></canvas>
                    </div>
                </div>
            </div>

        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tempo Médio de Manutenção Preventiva (MTTMP)</h5>
                        <canvas id="chartMTTMP" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tempo Médio de Quebra de Equipamento (MTTQE)</h5>
                        <canvas id="chartMTTQE" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Taxa de Disponibilidade</h5>
                        <canvas id="chartTaxaDisponibilidadePercentual" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Taxa de Falhas por Dia (%)</h5>
                        <canvas id="chartAvailability" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>